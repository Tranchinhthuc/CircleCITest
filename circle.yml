machine:
  timezone:
    Asia/Tokyo
  ruby:
    version: 2.4.0
  python:
    version: 2.7.3
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
    - "vendor/bundle"
  override:
    - sudo apt-get install jq && pip install awscli
    - ./script/docker-build-push.sh
    - bundle -j4 --path=vendor/bundle
    - bundle

database:
  override:
    - mv config/database.ci.yml config/database.yml
    - bundle exec rake db:create db:schema:load --trace

test:
  override:
    - bundle exec rspec ./spec/models

deployment:
  staging:
    branch: staging
    commands:
      - ./script/ecs-deploy/ecs-deploy -c strong-career-staging -n strong-career-staging -i 946344263380.dkr.ecr.ap-northeast-1.amazonaws.com/strong-career-staging:latest -k AwsUserId -s AwsUserPassWord -r ap-northeast-1 -t 600 && ./script/slack-deploy-notify.sh
  production:
    branch: master
    commands:
      - ./script/ecs-deploy/ecs-deploy -c strong-career-production -n strong-career-production -i 946344263380.dkr.ecr.ap-northeast-1.amazonaws.com/strong-career-master:latest -k UserId -s UserPassWord -r ap-northeast-1 -t 600 && ./script/slack-deploy-notify.sh

# notify:
#   webhooks:
#     - url: https://hooks.slack.com/services/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

# experimental:
#   notify:
#     branches:
#       only:
#         - master
#         - staging
#         - topic/access-ranking
